# Hotel Booking System

Микросервисная система бронирования отелей, разработанная на Spring Boot с использованием современных технологий и лучших практик.

## Архитектура

Система состоит из следующих компонентов:

### Сервисы

1. **Eureka Server** (порт 8761)
   - Сервис регистрации и обнаружения микросервисов
   - Централизованный реестр всех доступных сервисов

2. **API Gateway** (порт 8080)
   - Единая точка входа для всех клиентских запросов
   - Маршрутизация запросов к соответствующим сервисам
   - JWT аутентификация и авторизация

3. **Hotel Service** (порт 8081)
   - Управление отелями и номерами
   - CRUD операции для отелей и номеров
   - Алгоритм планирования занятости номеров
   - Статистика загрузки номеров

4. **Booking Service** (порт 8082)
   - Управление бронированиями
   - Аутентификация и авторизация пользователей
   - Реализация паттерна Saga для распределенных транзакций

### Технологии

- **Java 17**
- **Spring Boot 3.5.x**
- **Spring Cloud (2024.0.0)**
- **Spring Data JPA + H2** (in-memory базы данных)
- **Spring Security + JWT** (аутентификация)
- **Spring Cloud Eureka** (service discovery)
- **Spring Cloud Gateway** (API gateway)
- **Spring Cloud OpenFeign** (межсервисное взаимодействие)
- **Resilience4j** (circuit breaker, retry)
- **Lombok** (сокращение boilerplate кода)
- **MapStruct** (маппинг DTO)

## Запуск системы

### Предварительные требования

- Java 17 или выше
- Maven 3.6+

### Порядок запуска

1. **Запустить Eureka Server**
   ```bash
   cd eureka-server
   mvn spring-boot:run
   ```

2. **Запустить Hotel Service**
   ```bash
   cd hotel-service
   mvn spring-boot:run
   ```

3. **Запустить Booking Service**
   ```bash
   cd booking-service
   mvn spring-boot:run
   ```

4. **Запустить API Gateway**
   ```bash
   cd api-gateway
   mvn spring-boot:run
   ```

### Альтернативный способ запуска

Запустить все сервисы одной командой из корневой директории:
```bash
mvn clean install
```

Затем запустить каждый сервис в отдельном терминале.

## API Документация

После запуска всех сервисов, документация OpenAPI будет доступна:

- **API Gateway**: http://localhost:8080/swagger-ui.html
- **Hotel Service**: http://localhost:8081/swagger-ui.html
- **Booking Service**: http://localhost:8082/swagger-ui.html

## Тестовые данные

### Пользователи

- **Администратор**: `admin` / `admin123`
- **Пользователь**: `user` / `user123`

### Отели и номера

При запуске с профилем `dev` базы данных предзаполняются тестовыми данными:

- **Отель 1**: "Гранд Отель Москва" (3 номера)
- **Отель 2**: "Спорт Отель" (3 номера)
- **Отель 3**: "Бизнес Центр" (2 номера)

## Основные эндпоинты

### Аутентификация

```bash
# Регистрация
POST /api/user/register
{
  "username": "newuser",
  "password": "password123"
}

# Вход
POST /api/user/auth
{
  "username": "user",
  "password": "user123"
}
```

### Бронирование

```bash
# Создать бронирование с автоподбором номера
POST /api/booking
Authorization: Bearer <jwt-token>
{
  "startDate": "2024-12-25",
  "endDate": "2024-12-27",
  "autoSelect": true
}

# Получить мои бронирования
GET /api/bookings
Authorization: Bearer <jwt-token>
```

### Управление отелями (только ADMIN)

```bash
# Создать отель
POST /api/hotels
Authorization: Bearer <jwt-token>
{
  "name": "Новый Отель",
  "address": "ул. Ленина, 10"
}

# Получить рекомендованные номера
GET /api/rooms/recommend
```

## Алгоритм планирования занятости

Система использует интеллектуальный алгоритм распределения номеров:

1. **Сортировка по статистике**: номера сортируются по возрастанию `times_booked` (количество бронирований)
2. **Равномерная загрузка**: система стремится к равномерному распределению нагрузки между номерами
3. **Идемпотентность**: повторные запросы с одинаковым `requestId` не создают дубликатов

## Паттерн Saga

Бронирование реализовано через распределенную транзакцию Saga:

1. **Создание PENDING**: бронирование создается в статусе `PENDING`
2. **Подтверждение доступности**: запрос к Hotel Service
3. **Подтверждение/COMPENSATION**:
   - При успехе: `PENDING` → `CONFIRMED`
   - При неудаче: `PENDING` → `CANCELLED` + компенсация

## Мониторинг

### Health Checks

- **Eureka**: http://localhost:8761/actuator/health
- **API Gateway**: http://localhost:8080/actuator/health
- **Hotel Service**: http://localhost:8081/actuator/health
- **Booking Service**: http://localhost:8082/actuator/health

### H2 Консоли

- **Hotel Service**: http://localhost:8081/h2-console
- **Booking Service**: http://localhost:8082/h2-console

## Безопасность

- **JWT токены** с временем жизни 1 час
- **Ролевая модель**: `USER` и `ADMIN`
- **Resource Server** в каждом микросервисе
- **Защита от CSRF** отключена для API
- **CORS** настроен для кросс-доменных запросов

## Логирование

- **DEBUG уровень** для основных пакетов
- **Структурное логирование** с correlation ID
- **Трассировка запросов** между сервисами

## Разработка и тестирование

### Структура проекта

```
hotel-booking-system/
├── eureka-server/          # Сервис регистрации
├── api-gateway/           # API шлюз
├── hotel-service/         # Сервис отелей
├── booking-service/       # Сервис бронирований
├── pom.xml               # Корневой POM
└── README.md             # Документация
```

### Запуск тестов

```bash
mvn test
```

### Сборка проекта

```bash
mvn clean package
```

## Архитектурные решения

### Микросервисная архитектура
- **Разделение ответственности**: каждый сервис отвечает за свою доменную область
- **Независимое развертывание**: сервисы можно обновлять независимо
- **Масштабируемость**: сервисы можно масштабировать по отдельности

### Аутентификация и авторизация
- **JWT токены** для stateless аутентификации
- **Централизованная проверка** в API Gateway
- **Resource Server** в каждом сервисе для дополнительной защиты

### Обработка ошибок
- **Глобальные обработчики исключений** в каждом сервисе
- **Стандартизированные ответы** с кодами и сообщениями
- **Валидация входных данных** с понятными сообщениями

### Межсервисное взаимодействие
- **OpenFeign** для декларативных HTTP клиентов
- **Resilience4j** для устойчивости (retry, circuit breaker)
- **Saga паттерн** для распределенных транзакций

## Производительность и надежность

- **In-memory H2** базы данных для быстрого старта
- **Connection pooling** для эффективного использования соединений
- **Кэширование** конфигурации Eureka
- **Graceful shutdown** сервисов

## Будущие улучшения

- **PostgreSQL/MySQL** вместо H2 для production
- **Docker/Kubernetes** для оркестрации
- **Spring Cloud Config** для централизованной конфигурации
- **ELK Stack** для продвинутого логирования
- **Spring Cloud Sleuth** для распределенной трассировки
- **API Gateway rate limiting** для защиты от перегрузок
